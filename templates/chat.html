{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <title>JobBoard &mdash; Website Template by Colorlib</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    
    <link rel="stylesheet" href={% static "css/custom-bs.css" %}>
    <link rel="stylesheet" href={% static "css/jquery.fancybox.min.css" %}>
    <link rel="stylesheet" href={% static "css/bootstrap-select.min.css" %}>
    <link rel="stylesheet" href={% static "fonts/icomoon/style.css" %}>
    <link rel="stylesheet" href={% static "fonts/line-icons/style.css" %}>
    <link rel="stylesheet" href={% static "css/owl.carousel.min.css" %}>
    <link rel="stylesheet" href={% static "css/animate.min.css" %}>

    <!-- MAIN CSS -->
    <link rel="stylesheet" href={% static "css/style.css" %}>    
  </head>
  <body id="top">

  <div id="overlayer"></div>
  <div class="loader">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>
    

<div class="site-wrap">

    <div class="site-mobile-menu site-navbar-target">
      <div class="site-mobile-menu-header">
        <div class="site-mobile-menu-close mt-3">
          <span class="icon-close2 js-menu-toggle"></span>
        </div>
      </div>
      <div class="site-mobile-menu-body"></div>
    </div> <!-- .site-mobile-menu -->
    

    <!-- NAVBAR -->
   {% include "navbar.html" %}
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
      .containers { display: flex; width: 100vw; height: 100vh; background-color: black; }
      .recent { width: 280px; background: #232224; overflow-y: auto; padding: 10px; height: calc(100vh - 90px); margin-top: 90px; scrollbar-width: none; }
      .chatset { padding: 13px; background: #232224; border-bottom: 1px solid #333; cursor: pointer; }
      .names { font-size: 18px; color: white; text-align: center; }
      .chats { flex: 1; display: flex; flex-direction: column; background: #232224; height: calc(100vh - 90px); margin-top: 90px; }
      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        color: white;
        display: flex;
        flex-direction: column;  /* Change from column-reverse to column */
    }
    
      .msg, .reply { max-width: 60%; padding: 10px; border-radius: 8px; margin: 5px 0; }
      .msg { background: #2b2a29; align-self: flex-end; text-align: right; border-top-right-radius: 0; }
      .reply { background: #86827a; align-self: flex-start; text-align: left; border-top-left-radius: 0; }
      .btm { padding: 10px; display: flex; background: #232224; }
      .inpt { flex: 1; padding: 10px; border-radius: 12px; border: none; }
      .btn { background: black; color: white; padding: 10px; border-radius: 8px; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <div class="containers">
    <div class="recent">
      {% for session in sessions %}
      <a href={% url 'get_messages' session.id %}><div class="chatset"><div class="names">{{ session.company_name }} - {{ session.short_position_name }}
      </div></div></a>
        
      {% endfor %}
        {% comment %} <div class="chatset"><div class="names">Microsoft</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div>
        <div class="chatset"><div class="names">OpenAI</div></div> {% endcomment %}
    </div>
    <div class="chats">
        <div class="chat-container" id="chat-box"></div>
        
        <div class="btm">
            <input type="text" id="user-input" class="inpt" placeholder="Type a message...">
            <button class="btn" id='send_button' >Send</button>
        </div>
     
    </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
  document.getElementById("send_button").addEventListener("click", sendMessage);
  document.addEventListener("DOMContentLoaded", function() {
    let sendButton = document.getElementById("send_button");
    if (sendButton) {
        sendButton.addEventListener("click", sendMessage);
    } else {
        console.error("Send button not found!");
    }
});


      let chatBox = document.getElementById("chat-box");
      let sessionId = "{{ sessions.0.id }}";  // Use first session if available
  
      function getCSRFToken() {
        return document.cookie.split("; ")
            .find(row => row.startsWith("csrftoken="))
            ?.split("=")[1];
    }
    
  
      function loadChatMessages() {
          fetch(`/get_messages/${sessionId}/`)
              .then(response => response.json())
              .then(data => {
                  chatBox.innerHTML = "";  // Clear chat box before loading messages
                  data.messages.forEach(msg => {
                      let msgDiv = document.createElement("div");
                      msgDiv.className = msg.sender === "user" ? "msg" : "reply";
                      msgDiv.innerText = msg.message;
                      chatBox.appendChild(msgDiv);
                  });
                  chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to latest message
              });
      }
  
      function sendMessage(event) {
          event.preventDefault(); // Prevent form submission
  
          let inputField = document.getElementById("user-input");
          let message = inputField.value.trim();
          if (message === "") return;
  
          let chatData = {
              session_id: sessionId,
              message: message
          };
  
          fetch("/send_message/", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCSRFToken()
              },
              body: JSON.stringify(chatData)
          })
          .then(response => response.json())
          .then(data => {
              let userMsg = document.createElement("div");
              userMsg.className = "msg";
              userMsg.innerText = message;
              chatBox.appendChild(userMsg);
  
              setTimeout(() => {
                  let botReply = document.createElement("div");
                  botReply.className = "reply";
                  botReply.innerText = data.bot_reply;
                  chatBox.appendChild(botReply);
                  chatBox.scrollTop = chatBox.scrollHeight;
              }, 1000);
          });
  
          inputField.value = "";
      }
  
      loadChatMessages();  // Load previous messages on page load
  
      document.querySelector(".btm form").addEventListener("submit", sendMessage);
  });
  </script>
  
  
  
   
</div>

    <!-- SCRIPTS -->
    <script src={% static "js/jquery.min.js" %}></script>
    <script src={% static "js/bootstrap.bundle.min.js" %}></script>
    <script src={% static "js/isotope.pkgd.min.js" %}></script>
    <script src={% static "js/stickyfill.min.js" %}></script>
    <script src={% static "js/jquery.fancybox.min.js" %}></script>
    <script src={% static "js/jquery.easing.1.3.js" %}></script>
    
    <script src={% static "js/jquery.waypoints.min.js" %}></script>
    <script src={% static "js/jquery.animateNumber.min.js" %}></script>
    <script src={% static "js/owl.carousel.min.js" %}></script>
    
    <script src={% static "js/bootstrap-select.min.js" %}></script>
    
    <script src={% static "js/custom.js" %}></script>

     
  </body>
</html>